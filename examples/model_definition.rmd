---
title: "model_definition.rmd"
output: html_document
---

``` {r}
library(ggplot2)
library(reshape2)

library(reticulate)

model <- import("libcbm.model.model_definition.model")
output_processor <- import("libcbm.model.model_definition.output_processor")
cbm_variables <- import("libcbm.model.model_definition.cbm_variables")
```

``` {r}
pool_def = list(
  "Input",
  "WoodyBiomass",
  "Foliage",
  "SlowDOM",
  "MediumDOM",
  "FastDOM",
  "CO2",
  "Products"
)
```

``` {r}
processes = dict(
  GrowthAndMortality = 0L,
  Decay = 1L,
  Disturbance = 2L
)
```

``` {r}
flux_indicators = c(
    dict(
        name="NPP",
        process=processes["GrowthAndMortality"],
        source_pools=list(
            "Input",
            "Foliage"
        ),
        sink_pools=list(
            "WoodyBiomass",
            "Foliage",
            "FastDOM"
        )
    ),
    dict(
        name="DecayEmissions",
        process=processes["Decay"],
        source_pools=list(
            "SlowDOM",
            "MediumDOM",
            "FastDOM"
        ),
        sink_pools=list(
            "CO2"
        )
    ),
    dict(
        name="DisturbanceEmissions",
        process=processes["Disturbance"],
        source_pools=list(
            "WoodyBiomass",
            "Foliage",
            "SlowDOM",
            "MediumDOM",
            "FastDOM"
        ),
        sink_pools=list(
            "CO2"
        )
    ),
    dict(
        name="HarvestProduction",
        process=processes["Disturbance"],
        source_pools=list(
            "WoodyBiomass",
            "Foliage",
            "MediumDOM"
        ),
        sink_pools=list(
            "Products"
        )
    )
)
```

``` {r}
weibull_cumulative <- function(x, k=2.3, y=1) {
    c = (x/y) ^ k
    return(1 - exp(-c))
}

get_npp_matrix <- function(model, age) {
    # creates NPP flows based on an age passed to the cumulative weibull distribution
    n_stands = length(age)
    npp = matrix(weibull_cumulative((age+1)/100.0) - weibull_cumulative(age/100.0))
    op = model$create_operation(
        matrices=list(
            list("Input", "WoodyBiomass", npp),
            list("Input", "Foliage", npp/10.0)
        ),
        fmt="repeating_coordinates",
        matrix_index=matrix(seq(0L, n_stands-1)),
        process_id=processes["GrowthAndMortality"]
    )
    return(op)
}
```

``` {r}

get_mortality_matrix <- function(model, n_stands) {

    op = model$create_operation(
        matrices=list(
            list("WoodyBiomass", "WoodyBiomass", 1.0),
            list("WoodyBiomass", "MediumDOM", 0.01),
            list("Foliage", "Foliage", 1.0),
            list("Foliage", "FastDOM", 0.95)
        ),
        fmt="repeating_coordinates",
        # set every stand to point at the 0th matrix:
        # they all share the same simple mortality matrix
        matrix_index=matrix(rep(0L, n_stands)),
        process_id=processes["GrowthAndMortality"]
    )
    return(op)
}
```

``` {r}
get_decay_matrix <- function(model, n_stands) {
    op = model$create_operation(
        matrices=list(
            list("SlowDOM", "SlowDOM", 0.97),
            list("SlowDOM", "CO2", 0.03),

            list("MediumDOM", "MediumDOM", 0.85),
            list("MediumDOM", "SlowDOM", 0.10),
            list("MediumDOM", "CO2", 0.05),

            list("FastDOM", "FastDOM", 0.65),
            list("FastDOM", "MediumDOM", 0.25),
            list("FastDOM", "CO2", 0.10)
        ),
        fmt="repeating_coordinates",
        matrix_index=matrix(rep(0L, n_stands)),
        process_id=processes["Decay"]
    )

    return(op)
}
```

``` {r}
disturbance_type_ids = c(
    none=0L,
    fire=1L,
    harvest=2L
)

get_disturbance_matrix <- function(model, disturbance_types) {

    no_disturbance = list()

    fire_matrix = list(
        list("WoodyBiomass", "WoodyBiomass", 0.0),
        list("WoodyBiomass", "CO2", 0.85),
        list("WoodyBiomass", "MediumDOM", 0.15),
        list("Foliage", "Foliage", 0.0),
        list("Foliage", "CO2", 0.95),
        list("Foliage", "FastDOM", 0.05)
    )
    harvest_matrix = list(
        list("WoodyBiomass", "WoodyBiomass", 0.0),
        list("WoodyBiomass", "Products", 0.85),
        list("WoodyBiomass", "MediumDOM", 0.15),
        list("Foliage", "Foliage", 0.0),
        list("Foliage", "FastDOM", 1.0)
    )

    op = model$create_operation(
        matrices=list(
            no_disturbance, fire_matrix, harvest_matrix
        ),
        fmt="matrix_list",
        matrix_index=matrix(disturbance_types),
        process_id=processes["Disturbance"]
    )
    return(op)
}

```

``` {r}

with(model$initialize(pool_def, flux_indicators) %as% cbm_model, {

    out_processor = output_processor$ModelOutputProcessor()
    n_stands = 20000L

    model_vars <- cbm_variables$CBMVariables$from_pandas(
      dict(
        pools=data.frame(
          matrix(
            0.0,
            nrow=n_stands,
            ncol=length(cbm_model$pool_names),
            dimnames=list(NULL, cbm_model$pool_names)
          )
        ),
        flux=data.frame(
          matrix(
            0.0,
            nrow=n_stands,
            ncol=length(cbm_model$flux_names),
            dimnames=list(NULL, cbm_model$flux_names)
          )
        ),
        state=data.frame(
          matrix(1L, nrow=n_stands, ncol=1, dimnames=list(NULL, c("enabled")))
        )
      )
    )


    model_vars["pools"]["Input"]$assign(1.0)

    stand_age = rep(0L, n_stands)

    timesteps <- 0:100L
    for(t in timesteps) {
        print(t)
        # add some simplistic disturbance scheduling
        disturbance_types = sample(
          c(0L,1L,2L),
          n_stands,
          replace=TRUE,
          prob=c(0.995, 0.003, 0.002)
        )

        # reset flux at start of every time step
        model_vars["flux"]$zero()

        # prepare the matrix operations
        operations <- list(
            get_disturbance_matrix(cbm_model, disturbance_types),
            get_npp_matrix(cbm_model, stand_age),
            get_mortality_matrix(cbm_model, n_stands),
            get_decay_matrix(cbm_model, n_stands)
        )

        # enabled array can be used to disable(0)/enable(1)
        # dynamics per index
        model_vars["state"]["enabled"]$assign(
          rep(1L, n_stands))
        #print(operations[1]$op_process_id)
        #print(operations[2]$op_process_id)
        cbm_model$compute(model_vars, operations)

        for(op in operations){
            op$dispose()
        }

        #out_processor$append_results(t, model_vars)
        stand_age[disturbance_types != 0] = 0
        stand_age = stand_age + 1
    }
})
```
